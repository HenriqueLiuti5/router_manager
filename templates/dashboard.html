<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Router Manager</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/router-manager.png') }}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/style-dashboard.css')}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-brand">
            <i class="fa-solid fa-wifi"></i>
        </div>
        <ul class="sidebar-menu">
            <li class="active"><a href="#"><i class="fa-solid fa-chart-pie"></i></a></li>
            <li><a href="#" style="opacity: 0.5; cursor: not-allowed;"><i class="fa-solid fa-gear"></i></a></li>
        </ul>
        <div class="sidebar-footer">
            <form action="{{ url_for('logout') }}" method="POST">
                <button type="submit" class="btn-sidebar-logout" title="Sair">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>
            </form>
            <span class="app-version">v1.0.0</span>
        </div>
    </nav>

    <main class="main-content">
        <header class="top-bar">
            <div class="user-welcome">
                <h1>Painel de Controle</h1>
                <p>Visão geral da sua rede</p>
            </div>
            <div class="user-profile">
                <div class="avatar-circle">
                    {{ current_user.username[0] | upper }}
                </div>
                <div class="user-info">
                    <span class="name">{{ current_user.username }}</span>
                    <span class="role">{{ 'Administrador' if current_user.is_admin else 'Visualizador' }}</span>
                </div>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon total">
                    <i class="fa-solid fa-server"></i>
                </div>
                <div class="kpi-data">
                    <span class="kpi-value">{{ routers|length }}</span>
                    <span class="kpi-label">Total de Dispositivos</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon online">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="kpi-data">
                    <span class="kpi-value" id="count-online">0</span>
                    <span class="kpi-label">Roteadores Online</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon issue">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <div class="kpi-data">
                    <span class="kpi-value" id="count-issue">0</span>
                    <span class="kpi-label">Roteadores offline</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <h2>Dispositivos Monitorados</h2>
                </div>
                {% if current_user.is_admin %}
                <button class="btn-primary" onclick="openModal()">
                    <i class="fa-solid fa-plus"></i> Novo Dispositivo
                </button>
                {% endif %}
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Local</th>
                            <th>Modelo</th>
                            <th>Serial</th>
                            <th>Acesso</th>
                            <th>Dispositivo 1</th>
                            <th>Dispositivo 2</th>
                            {% if current_user.is_admin %}
                            <th>Ações</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for router in routers %}
                        <tr>
                            <td class="status-cell" data-id="{{ router.id }}">
                                <span class="status-badge status-loading">
                                    <i class="fa-solid fa-spinner fa-spin"></i> Verificando
                                </span>
                            </td>
                            <td class="fw-500">{{ router.local }}</td>
                            <td class="text-muted">{{ router.model }}</td>
                            <td class="font-mono">{{ router.serial }}</td>
                            <td>
                                <a href="{{router.link}}" target="_blank" class="link-external">
                                    Router <i class="fa-solid fa-up-right-from-square"></i>
                                </a>
                            </td>
                            <td>
                                {% if router.link1 %}
                                <a href="{{router.link1}}" target="_blank" class="link-external">
                                    Dispositivo 1 <i class="fa-solid fa-up-right-from-square"></i>
                                </a>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if router.link2 %}
                                <a href="{{router.link2}}" target="_blank" class="link-external">
                                    Dispositivo 2 <i class="fa-solid fa-up-right-from-square"></i>
                                </a>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            
                            {% if current_user.is_admin %}
                            <td>
                                <div class="action-buttons" style="justify-content: center;">
                                    <button class="btn-icon delete" onclick="openDeleteModal('{{router.id}}')" title="Excluir">
                                        <i class="fa-regular fa-trash-can"></i>
                                    </button>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fa-solid fa-router"></i>
                                    </div>
                                    <h3>Nenhum dispositivo encontrado</h3>
                                    <p>Cadastre um novo roteador para começar o monitoramento.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="routerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Novo Dispositivo</h3>
                <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form action="{{ url_for('add_router') }}" method="POST">
                <div class="modal-body">
                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                        <div class="flash-wrapper">
                            {% for message in messages %}
                                <div class="alert">{{ message }}</div>
                            {% endfor %}
                        </div>
                        <script>document.addEventListener("DOMContentLoaded", function() { openModal(); });</script>
                        {% endif %}
                    {% endwith %}

                    <div class="input-group">
                        <label>Localização</label>
                        <input type="text" name="local" placeholder="Ex: Matriz - Sala TI" required>
                    </div>

                    <div class="row-2">
                        <div class="input-group">
                            <label>Modelo</label>
                            <input type="text" name="model" placeholder="Ex: RUT200" required>
                        </div>
                        <div class="input-group">
                            <label>Serial Number</label>
                            <input type="text" name="serial" placeholder="Ex: 1107..." required>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Link de Acesso</label>
                        <input type="url" name="link" placeholder="http://..." required>
                    </div>

                    <div class="input-group">
                        <label>Link do Dispositivo 1</label>
                        <input type="url" name="link1" placeholder="http://...">
                    </div>

                    <div class="input-group">
                        <label>Link do Dispositivo 2</label>
                        <input type="url" name="link2" placeholder="http://..."">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-text" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar Equipamento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-box modal-small">
            <div class="modal-content-center">
                <div class="icon-warning">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3>Excluir dispositivo?</h3>
                <p>Essa ação removerá permanentemente o roteador do painel de monitoramento.</p>
                
                <form action="{{ url_for('delete') }}" method="POST">
                    <input type="hidden" id="delete_router_id" name="id" value="">
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                        <button type="submit" class="btn-danger">Sim, excluir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const routerModal = document.getElementById("routerModal");
        const deleteModal = document.getElementById("deleteModal");
        const deleteInput = document.getElementById("delete_router_id");

        function openModal() { routerModal.classList.add('active'); }
        function closeModal() { routerModal.classList.remove('active'); }
        
        function openDeleteModal(id) {
            deleteInput.value = id;
            deleteModal.classList.add('active');
        }
        function closeDeleteModal() { deleteModal.classList.remove('active'); }

        window.onclick = function(e) {
            if (e.target == routerModal) closeModal();
            if (e.target == deleteModal) closeDeleteModal();
        }

        document.addEventListener("DOMContentLoaded", function() {
            const statusCells = document.querySelectorAll('.status-cell');
            let onlineCount = 0;
            let issueCount = 0;
            const totalRouters = statusCells.length;

            const elOnline = document.getElementById('count-online');
            const elIssue = document.getElementById('count-issue');

            statusCells.forEach(cell => {
                const routerId = cell.getAttribute('data-id');
                
                fetch(`/check_status/${routerId}`)
                    .then(response => response.json())
                    .then(data => {
                        let html = '';
                        if (data.status === 'online') {
                            onlineCount++;
                            html = `<span class="status-badge status-online">
                                        <span class="dot"></span> Online
                                    </span>`;
                        } else if (data.status === 'warning') {
                            issueCount++;
                            html = `<span class="status-badge status-warning">
                                        <span class="dot"></span> Alerta
                                    </span>`;
                        } else {
                            issueCount++;
                            html = `<span class="status-badge status-offline">
                                        <span class="dot"></span> Offline
                                    </span>`;
                        }
                        cell.innerHTML = html;
                        
                        if(elOnline) elOnline.textContent = onlineCount;
                        if(elIssue) elIssue.textContent = issueCount;
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        cell.innerHTML = `<span class="status-badge status-offline">Erro</span>`;
                        issueCount++;
                        if(elIssue) elIssue.textContent = issueCount;
                    });
            });
        });
    </script>
</body>
</html>